<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ZeE Store</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
<style>
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Poppins', sans-serif;
  }

  body {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
    padding: 20px;
    padding-top: 100px;
  }

  .hamburger-btn {
    position: fixed;
    top: 90px;
    left: 15px;
    width: 50px;
    height: 50px;
    background: rgba(255, 255, 255, 0.95);
    border: 2px solid rgba(102, 126, 234, 0.3);
    border-radius: 12px;
    cursor: pointer;
    z-index: 1001;
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 6px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .hamburger-btn.show {
    display: flex;
  }

  .hamburger-btn:hover {
    background: white;
    border-color: #667eea;
    transform: scale(1.05);
  }

  .hamburger-btn span {
    width: 25px;
    height: 3px;
    background: #667eea;
    border-radius: 2px;
    transition: all 0.3s ease;
  }

  .hamburger-btn.active span:nth-child(1) {
    transform: rotate(45deg) translate(8px, 8px);
  }

  .hamburger-btn.active span:nth-child(2) {
    opacity: 0;
  }

  .hamburger-btn.active span:nth-child(3) {
    transform: rotate(-45deg) translate(8px, -8px);
  }

  .admin-sidebar {
    position: fixed;
    top: 0;
    left: -320px;
    width: 320px;
    height: 100vh;
    background: white;
    box-shadow: 2px 0 20px rgba(0,0,0,0.3);
    z-index: 1000;
    transition: left 0.3s ease;
    overflow-y: auto;
    display: none;
  }

  .admin-sidebar.show {
    display: block;
  }

  .admin-sidebar.active {
    left: 0;
  }

  .admin-sidebar-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 25px;
    text-align: center;
  }

  .admin-sidebar-header h2 {
    font-size: 2em;
    font-family: 'Brush Script MT', cursive;
    margin-bottom: 5px;
  }

  .admin-sidebar-header p {
    font-size: 0.9em;
    opacity: 0.95;
  }

  .admin-menu {
    padding: 20px 0;
  }

  .admin-menu-item {
    padding: 18px 25px;
    display: flex;
    align-items: center;
    gap: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    border-left: 4px solid transparent;
    color: #333;
    font-weight: 500;
  }

  .admin-menu-item:hover {
    background: #f5f5f5;
    border-left-color: #667eea;
    color: #667eea;
  }

  .admin-menu-item .icon {
    font-size: 1.3em;
  }

  .sidebar-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
    display: none;
    transition: opacity 0.3s ease;
  }

  .sidebar-overlay.show {
    display: block;
  }

  .sidebar-overlay.active {
    display: block;
  }

  .navbar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 15px 40px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 20px rgba(0,0,0,0.1);
    z-index: 1000;
  }

  .navbar-left {
    display: flex;
    align-items: center;
    gap: 30px;
  }

  .navbar-logo {
    font-size: 1.8em;
    font-weight: 700;
    background: linear-gradient(45deg, #667eea, #764ba2);
    background-clip: text;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    font-family: 'Brush Script MT', cursive;
  }

  .navbar-links {
    display: flex;
    gap: 25px;
  }

  .navbar-links a {
    color: #333;
    text-decoration: none;
    font-weight: 500;
    font-size: 0.95em;
    transition: all 0.3s ease;
    padding: 8px 15px;
    border-radius: 8px;
  }

  .navbar-links a:hover {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .navbar-right {
    display: flex;
    align-items: center;
    gap: 15px;
  }

  .profile-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    font-weight: 600;
  }

  .profile-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .cart-btn {
    position: relative;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-size: 1.2em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
  }

  .cart-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
  }

  .cart-badge {
    position: absolute;
    top: -8px;
    right: -8px;
    background: #ff4757;
    color: white;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    display: none;
    align-items: center;
    justify-content: center;
    font-size: 0.7em;
    font-weight: bold;
  }

  .logout-btn {
    background: white;
    border: 2px solid #667eea;
    color: #667eea;
    padding: 10px 20px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.95em;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.3s ease;
  }

  .logout-btn:hover {
    background: #667eea;
    color: white;
    transform: translateY(-2px);
  }

  h1 {
    color: white;
    text-align: center;
    margin: 20px 0 40px;
    font-size: 2.5em;
    text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
  }

  .admin-title {
    color: white;
    text-align: center;
    margin: 20px 0 40px;
    font-size: 3em;
    text-shadow: 3px 3px 6px rgba(0,0,0,0.4);
    font-weight: 700;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  #products-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 25px;
    max-width: 1400px;
    margin: 0 auto;
    padding-bottom: 100px;
  }

  .product-card {
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
    transition: transform 0.3s ease;
    position: relative;
  }

  .product-card:hover {
    transform: translateY(-5px);
  }

  .product-card img {
    width: 100%;
    height: 200px;
    object-fit: cover;
    border-radius: 10px;
    margin-bottom: 15px;
  }

  .product-card h3 {
    font-size: 1.1em;
    margin-bottom: 10px;
    color: #333;
  }

  .price {
    font-size: 1.5em;
    font-weight: bold;
    color: #667eea;
    margin-bottom: 15px;
  }

  .price::before {
    content: "‚Ç±";
  }

  .edit-btn, .delete-btn {
    position: absolute;
    top: 10px;
    padding: 8px 15px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    font-size: 0.85em;
    transition: all 0.3s ease;
  }

  .edit-btn {
    right: 90px;
    background: #ffc107;
    color: #333;
  }

  .delete-btn {
    right: 10px;
    background: #ff4757;
    color: white;
  }

  .add-cart-btn, .details-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 600;
    font-size: 1em;
    transition: all 0.3s ease;
    margin-top: 10px;
  }

  .add-cart-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .details-btn {
    background: #f1f1f1;
    color: #333;
  }

  .add-cart-btn:hover, .details-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  #cart-sidebar, #trash-sidebar {
    position: fixed;
    top: 0;
    right: -400px;
    width: 400px;
    height: 100%;
    background: white;
    box-shadow: -5px 0 15px rgba(0,0,0,0.3);
    transition: right 0.3s ease;
    padding: 20px;
    overflow-y: auto;
    z-index: 2000;
  }

  #cart-sidebar.open, #trash-sidebar.open {
    right: 0;
  }

  #close-cart-btn, #close-trash-btn {
    position: absolute;
    top: 15px;
    right: 15px;
    background: none;
    border: none;
    font-size: 2em;
    cursor: pointer;
    color: #999;
  }

  .cart-item, .trash-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
    border-bottom: 1px solid #eee;
  }

  .remove-btn, .restore-btn, .perm-delete-btn {
    padding: 6px 12px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 600;
    margin-left: 5px;
  }

  .remove-btn {
    background: #ff4757;
    color: white;
  }

  .restore-btn {
    background: #2ecc71;
    color: white;
  }

  .perm-delete-btn {
    background: #e74c3c;
    color: white;
  }

  #checkout-btn {
    width: 100%;
    padding: 15px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    border-radius: 10px;
    font-size: 1.1em;
    font-weight: 600;
    cursor: pointer;
    margin-top: 20px;
  }

  #controls {
    position: fixed;
    bottom: 30px;
    right: 30px;
    display: flex;
    gap: 20px;
    z-index: 1000;
  }

  .control-btn {
    width: 70px;
    height: 70px;
    border-radius: 50%;
    border: none;
    font-size: 2em;
    cursor: pointer;
    box-shadow: 0 8px 25px rgba(0,0,0,0.4);
    transition: all 0.4s ease;
    position: relative;
    overflow: hidden;
  }

  .control-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(255,255,255,0.3), rgba(255,255,255,0));
    opacity: 0;
    transition: opacity 0.3s ease;
  }

  .control-btn:hover::before {
    opacity: 1;
  }

  #trash-btn {
    background: linear-gradient(135deg, #ff6b6b 0%, #ee5a6f 50%, #c44569 100%);
    color: white;
    animation: pulse-red 2s infinite;
  }

  #add-btn {
    background: linear-gradient(135deg, #56ab2f 0%, #a8e063 100%);
    color: white;
    animation: pulse-green 2s infinite;
  }

  @keyframes pulse-red {
    0%, 100% { box-shadow: 0 8px 25px rgba(255,75,87,0.4); }
    50% { box-shadow: 0 8px 35px rgba(255,75,87,0.6), 0 0 20px rgba(255,75,87,0.4); }
  }

  @keyframes pulse-green {
    0%, 100% { box-shadow: 0 8px 25px rgba(86,171,47,0.4); }
    50% { box-shadow: 0 8px 35px rgba(86,171,47,0.6), 0 0 20px rgba(168,224,99,0.4); }
  }

  .control-btn:hover {
    transform: scale(1.15) rotate(10deg);
  }

  #trash-btn:hover { box-shadow: 0 12px 40px rgba(255,75,87,0.7); }
  #add-btn:hover { box-shadow: 0 12px 40px rgba(86,171,47,0.7); }

  .modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.7);
    justify-content: center;
    align-items: center;
    z-index: 3000;
    overflow-y: auto;
    padding: 20px;
  }

  .modal.show {
    display: flex;
  }

  .modal-content {
    background: white;
    padding: 30px;
    border-radius: 15px;
    max-width: 500px;
    width: 100%;
    max-height: 80vh;
    overflow-y: auto;
    margin: auto;
  }

  .modal-content h2 {
    margin-bottom: 20px;
    color: #333;
  }

  .modal-content input, .modal-content textarea, .modal-content select {
    width: 100%;
    padding: 12px;
    margin-bottom: 15px;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    font-size: 1em;
    font-family: 'Poppins', sans-serif;
  }

  .modal-content textarea {
    min-height: 100px;
    resize: vertical;
  }

  .modal-btn {
    padding: 12px 30px;
    border: none;
    border-radius: 8px;
    font-size: 1em;
    font-weight: 600;
    cursor: pointer;
    margin-right: 10px;
    transition: all 0.3s ease;
  }

  .save-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
  }

  .cancel-btn {
    background: #f1f1f1;
    color: #333;
  }

  .modal-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }

  .users-modal-content {
    max-width: 900px;
  }

  .users-modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px 30px;
    margin: -30px -30px 20px -30px;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .users-modal-header h2 {
    color: white;
    margin: 0;
    font-size: 1.8em;
  }

  .close-users-modal {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 1.8em;
    width: 45px;
    height: 45px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    padding: 0;
  }

  .close-users-modal:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
  }

  .users-list {
    display: flex;
    flex-direction: column;
    gap: 15px;
  }

  .user-card {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 2px solid #e0e0e0;
    transition: all 0.3s ease;
  }

  .user-card:hover {
    border-color: #667eea;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
  }

  .user-info {
    flex: 1;
  }

  .user-info h3 {
    color: #333;
    font-size: 1.2em;
    margin-bottom: 8px;
  }

  .user-info p {
    color: #666;
    font-size: 0.95em;
    margin: 3px 0;
  }

  .user-delete-btn {
    background: #ff4757;
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
  }

  .user-delete-btn:hover {
    background: #ff3838;
    transform: scale(1.05);
  }

  .loading, .no-users {
    text-align: center;
    padding: 40px;
    color: #666;
    font-size: 1.1em;
  }

  .message {
    padding: 12px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    font-weight: 500;
    text-align: center;
  }

  .message.success {
    background: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
  }

  .message.error {
    background: #f8d7da;
    color: #721c24;
    border: 1px solid #f5c6cb;
  }

  @media (max-width: 768px) {
    .navbar {
      padding: 10px 20px;
      flex-wrap: wrap;
    }

    .navbar-links {
      display: none;
    }

    body {
      padding-top: 80px;
    }

    .user-card {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }

    .user-delete-btn {
      width: 100%;
    }

    .users-modal-content {
      width: 95%;
    }
  }
</style>
</head>
<body>
  <div class="hamburger-btn" id="hamburgerBtn">
    <span></span>
    <span></span>
    <span></span>
  </div>

  <div class="admin-sidebar" id="adminSidebar">
    <div class="admin-sidebar-header">
      <h2>ZeE Admin</h2>
      <p>Dashboard Controls</p>
    </div>
    <div class="admin-menu">
      <div class="admin-menu-item" id="usersMenuBtn">
        <span class="icon">üë•</span>
        <span>Manage Users</span>
      </div>
    </div>
  </div>

  <div class="sidebar-overlay" id="sidebarOverlay"></div>

  <nav class="navbar">
    <div class="navbar-left">
      <div class="navbar-logo">ZeE Store</div>
      <div class="navbar-links">
        <a href="aboutus.html">About Us</a>
        <a href="contactus.html">Contact Us</a>
      </div>
    </div>
    <div class="navbar-right">
      <button class="cart-btn" id="cart-btn" style="display: none;">
        üõí Cart
        <span class="cart-badge" id="cart-badge">0</span>
      </button>
      <button class="profile-btn" id="profile-btn" style="display: none;">
        üë§ Profile
      </button>
      <button class="profile-btn" id="addresses-btn" style="display: none;">
        üìç Addresses
      </button>
      <button class="logout-btn" id="logout-btn">
        üö™ Logout
      </button>
    </div>
  </nav>

  <h1 id="page-title">Welcome to ZeE Store</h1>

  <div id="cart-sidebar">
    <button id="close-cart-btn">√ó</button>
    <h2>Shopping Cart</h2>
    <div id="cart-items"></div>
    <hr style="margin: 15px 0;" />
    <div style="font-size: 1.2em; font-weight: bold;">Total: ‚Ç±<span id="cart-total">0.00</span></div>
    <button id="checkout-btn">Checkout</button>
  </div>

  <div id="trash-sidebar">
    <button id="close-trash-btn">√ó</button>
    <h2>Deleted Products</h2>
    <div id="trash-items"></div>
  </div>

  <div id="products-grid"></div>

  <div id="controls">
    <button id="trash-btn" class="control-btn">üóëÔ∏è</button>
    <button id="add-btn" class="control-btn">+</button>
  </div>

  <div id="edit-modal" class="modal">
    <div class="modal-content">
      <h2>Edit Product</h2>
      <input type="text" id="edit-name" placeholder="Product Name" />
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="edit-image" placeholder="Image URL" style="flex: 1;" />
        <input type="file" id="edit-image-file" accept="image/*" style="display: none;" />
        <button type="button" id="upload-edit-btn" class="modal-btn save-btn" style="padding: 12px 20px; white-space: nowrap;">üìÅ Upload File</button>
      </div>
      <textarea id="edit-desc" placeholder="Description"></textarea>
      <input type="number" id="edit-price" placeholder="Price" step="0.01" />
      <button class="modal-btn save-btn" id="save-edit-btn">SAVE</button>
      <button class="modal-btn cancel-btn" id="cancel-edit-btn">Cancel</button>
    </div>
  </div>

  <div id="add-modal" class="modal">
    <div class="modal-content">
      <h2>ADD A PRODUCT</h2>
      <input type="text" id="add-name" placeholder="NAME" />
      <div style="display: flex; gap: 10px; margin-bottom: 15px;">
        <input type="text" id="add-image" placeholder="INSERT IMAGE URL" style="flex: 1;" />
        <input type="file" id="add-image-file" accept="image/*" style="display: none;" />
        <button type="button" id="upload-add-btn" class="modal-btn save-btn" style="padding: 12px 20px; white-space: nowrap;">üìÅ Upload File</button>
      </div>
      <textarea id="add-desc" placeholder="DESCRIPTION"></textarea>
      <input type="number" id="add-price" placeholder="PRICE" step="0.01" />
      <button class="modal-btn save-btn" id="save-add-btn">Add</button>
      <button class="modal-btn cancel-btn" id="cancel-add-btn">Cancel</button>
    </div>
  </div>

  <div id="address-modal" class="modal">
    <div class="modal-content">
      <h2>Add Address</h2>
      <input type="text" id="addr-name" placeholder="COMPLETE NAME" />
      <input type="text" id="addr-street" placeholder="STREET" />
      <input type="text" id="addr-city" placeholder="CITY" />
      <select id="addr-province">
        <option value="">Select Province</option>
        <option>Metro Manila</option>
        <option>Cebu</option>
        <option>Davao</option>
        <option>Cavite</option>
        <option>Laguna</option>
        <option>Bulacan</option>
        <option>Pampanga</option>
        <option>Batangas</option>
        <option>Rizal</option>
        <option>Pangasinan</option>
      </select>
      <input type="text" id="addr-zip" placeholder="ZIP CODE" />
      <select id="addr-country">
        <option value="">Select Country</option>
        <option>Philippines</option>
        <option>United States</option>
        <option>Canada</option>
        <option>Australia</option>
        <option>United Kingdom</option>
        <option>Singapore</option>
        <option>Japan</option>
        <option>South Korea</option>
      </select>
      <input type="tel" id="addr-phone" placeholder="PHONE NUMBER" />
      <input type="email" id="addr-email" placeholder="EMAIL ADDRESS" />
      <button class="modal-btn save-btn" id="save-addr-btn">Save</button>
      <button class="modal-btn cancel-btn" id="cancel-addr-btn">Cancel</button>
    </div>
  </div>

  <div id="details-modal" class="modal">
    <div class="modal-content">
      <h2 id="details-name"></h2>
      <p id="details-desc"></p>
      <button id="details-add-cart-btn" class="modal-btn save-btn">Add to Cart</button>
      <button id="details-close-btn" class="modal-btn cancel-btn">Close</button>
    </div>
  </div>

  <div id="users-modal" class="modal">
    <div class="modal-content users-modal-content">
      <div class="users-modal-header">
        <h2>üë• Manage Users</h2>
        <button class="close-users-modal" id="close-users-modal">√ó</button>
      </div>
      <div id="users-message"></div>
      <div id="users-list" class="users-list"></div>
    </div>
  </div>

  <script>
    const API_URL = "http://localhost:5000/api";
    
    const isAdmin = localStorage.getItem("admin") !== null;
    const isUser = localStorage.getItem("user") !== null;
    
    if (!isAdmin && !isUser) {
      window.location.href = "login.html";
    }
    
    if (isAdmin) {
      document.getElementById("page-title").textContent = "ADMIN DASHBOARD";
      document.getElementById("page-title").className = "admin-title";
      document.getElementById("controls").style.display = "flex";
      document.getElementById("cart-btn").style.display = "none";
      document.getElementById("profile-btn").style.display = "none";
      document.getElementById("addresses-btn").style.display = "none";
      document.getElementById("hamburgerBtn").classList.add("show");
      document.getElementById("adminSidebar").classList.add("show");
    } else {
      document.getElementById("page-title").textContent = "Welcome to ZeE Store";
      document.getElementById("controls").style.display = "none";
      document.getElementById("cart-btn").style.display = "flex";
      document.getElementById("profile-btn").style.display = "flex";
      document.getElementById("addresses-btn").style.display = "flex";
    }
    
    let products = [];
    let cart = [];
    let deletedProducts = [];
    let currentEditId = null;
    let userAddress = JSON.parse(localStorage.getItem("userAddress")) || null;
    let allUsers = [];

    // ==================== PRICE FORMATTER ====================
    function formatPrice(price) {
      return price.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

    // ==================== LOAD USER ADDRESS FROM SERVER ====================
    async function loadUserAddress() {
      try {
        console.log("üîç Checking for existing address...");
        const res = await fetch(`${API_URL}/address`);
        if (res.ok) {
          const data = await res.json();
          console.log("üì¶ Address response:", data);
          
          if (data.success && data.addresses && data.addresses.length > 0) {
            userAddress = data.addresses[0];
            localStorage.setItem("userAddress", JSON.stringify(userAddress));
            console.log("‚úÖ Address loaded from server:", userAddress);
          } else {
            console.log("‚ÑπÔ∏è No address found in database");
          }
        }
      } catch (err) {
        console.error("‚ùå Error loading address:", err);
      }
    }

    // ==================== HAMBURGER & SIDEBAR ====================
    const hamburgerBtn = document.getElementById("hamburgerBtn");
    const adminSidebar = document.getElementById("adminSidebar");
    const sidebarOverlay = document.getElementById("sidebarOverlay");

    hamburgerBtn.addEventListener("click", () => {
      hamburgerBtn.classList.toggle("active");
      adminSidebar.classList.toggle("active");
      sidebarOverlay.classList.toggle("active");
    });

    sidebarOverlay.addEventListener("click", () => {
      hamburgerBtn.classList.remove("active");
      adminSidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
    });

    // ==================== USERS MENU ====================
    const usersMenuBtn = document.getElementById("usersMenuBtn");
    const usersModal = document.getElementById("users-modal");
    const closeUsersModal = document.getElementById("close-users-modal");

    usersMenuBtn.addEventListener("click", () => {
      hamburgerBtn.classList.remove("active");
      adminSidebar.classList.remove("active");
      sidebarOverlay.classList.remove("active");
      loadUsers();
      usersModal.classList.add("show");
    });

    closeUsersModal.addEventListener("click", () => {
      usersModal.classList.remove("show");
    });

    usersModal.addEventListener("click", (e) => {
      if (e.target === usersModal) {
        usersModal.classList.remove("show");
      }
    });

    // ==================== LOAD USERS ====================
    async function loadUsers() {
      const usersList = document.getElementById("users-list");
      const userMessage = document.getElementById("users-message");
      
      usersList.innerHTML = '<div class="loading">Loading users...</div>';
      userMessage.innerHTML = "";

      try {
        const res = await fetch(`${API_URL}/users`);
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const data = await res.json();
        
        if (data && data.users && Array.isArray(data.users)) {
          allUsers = data.users;
        } else if (Array.isArray(data)) {
          allUsers = data;
        } else if (data && data.success === false) {
          throw new Error(data.message || "Failed to fetch users");
        } else {
          allUsers = [];
        }
        
        renderUsers();
      } catch (err) {
        console.error("Error fetching users:", err);
        usersList.innerHTML = `<div class="no-users">‚ùå Failed to load users.<br><small>${err.message}</small></div>`;
      }
    }

    // ==================== RENDER USERS ====================
    function renderUsers() {
      const usersList = document.getElementById("users-list");
      
      if (allUsers.length === 0) {
        usersList.innerHTML = '<div class="no-users">üì≠ No users found</div>';
        return;
      }

      usersList.innerHTML = "";
      allUsers.forEach((user) => {
        const userCard = document.createElement("div");
        userCard.className = "user-card";
        
        const displayName = user.first && user.last ? `${user.first} ${user.last}` : 
                           user.username || user.email || "Unknown";
        const userEmail = user.email || "N/A";
        const userId = user._id || "N/A";
        
        userCard.innerHTML = `
          <div class="user-info">
            <h3>${displayName}</h3>
            <p><strong>Email:</strong> ${userEmail}</p>
            <p><strong>ID:</strong> ${userId}</p>
            ${user.phone ? `<p><strong>Phone:</strong> ${user.phone}</p>` : ''}
            ${user.isAdmin ? `<p style="color: #667eea;"><strong>üëë Admin</strong></p>` : ''}
          </div>
          <button class="user-delete-btn" onclick="deleteUser('${userId}')">Delete</button>
        `;
        usersList.appendChild(userCard);
      });
    }

    // ==================== DELETE USER ====================
    async function deleteUser(userId) {
      if (!confirm("Are you sure you want to delete this user?")) {
        return;
      }

      try {
        const res = await fetch(`${API_URL}/users/${userId}`, {
          method: "DELETE"
        });

        const result = await res.json();

        if (!res.ok) {
          throw new Error(result.message || `HTTP error! status: ${res.status}`);
        }

        allUsers = allUsers.filter(u => u._id !== userId);
        renderUsers();
        showMessage("‚úÖ User deleted successfully!", "success");
      } catch (err) {
        console.error("Error deleting user:", err);
        showMessage("‚ùå Failed to delete user: " + err.message, "error");
      }
    }

    function showMessage(text, type) {
      const messageDiv = document.getElementById("users-message");
      messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
      setTimeout(() => {
        messageDiv.innerHTML = "";
      }, 3000);
    }

    // ==================== PRODUCTS ====================
    async function fetchProducts() {
      try {
        const res = await fetch(`${API_URL}/products`);
        const data = await res.json();
        
        if (Array.isArray(data)) {
          products = data;
        }
        renderProducts();
      } catch (err) {
        console.error("Error fetching from MongoDB:", err);
        renderProducts();
      }
    }

    function renderProducts() {
      const grid = document.getElementById("products-grid");
      grid.innerHTML = "";
      products.forEach((p) => {
        const card = document.createElement("div");
        card.className = "product-card";
        
        if (isAdmin) {
          card.innerHTML = `
            <button class="edit-btn" onclick="openEditModal('${p._id}')">EDIT</button>
            <button class="delete-btn" onclick="deleteProduct('${p._id}')">DELETE</button>
            <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/200'">
            <h3>${p.name}</h3>
            <p class="price">${formatPrice(p.price)}</p>
            <button class="add-cart-btn" onclick="addToCart('${p._id}')">Add to Cart</button>
            <button class="details-btn" onclick="openDetailsModal('${p._id}')">See details</button>
          `;
        } else {
          card.innerHTML = `
            <img src="${p.image}" alt="${p.name}" onerror="this.src='https://via.placeholder.com/200'">
            <h3>${p.name}</h3>
            <p class="price">${formatPrice(p.price)}</p>
            <button class="add-cart-btn" onclick="addToCart('${p._id}')">Add to Cart</button>
            <button class="details-btn" onclick="openDetailsModal('${p._id}')">See details</button>
          `;
        }
        
        grid.appendChild(card);
      });
    }

    function addToCart(id) {
      const product = products.find((p) => p._id === id);
      const existing = cart.find((item) => item._id === id);

      if (existing) {
        existing.qty++;
      } else {
        cart.push({ ...product, qty: 1 });
      }

      updateCart();
      document.getElementById("cart-sidebar").classList.add("open");
    }

    function updateCart() {
      const cartItems = document.getElementById("cart-items");
      const cartTotal = document.getElementById("cart-total");
      const cartBadge = document.getElementById("cart-badge");

      cartItems.innerHTML = "";
      let total = 0;
      let count = 0;

      cart.forEach((item) => {
        total += item.price * item.qty;
        count += item.qty;

        const div = document.createElement("div");
        div.className = "cart-item";
        div.innerHTML = `
          <div>
            <strong>${item.name}</strong><br>
            <small>x${item.qty}</small>
          </div>
          <div>
            ‚Ç±${formatPrice(item.price * item.qty)}
            <button class="remove-btn" onclick="removeFromCart('${item._id}')">REMOVE</button>
          </div>
        `;
        cartItems.appendChild(div);
      });

      cartTotal.textContent = formatPrice(total);

      if (count > 0) {
        cartBadge.style.display = "flex";
        cartBadge.textContent = count;
      } else {
        cartBadge.style.display = "none";
      }
    }

    function removeFromCart(id) {
      cart = cart.filter((item) => item._id !== id);
      updateCart();
    }

    function openEditModal(id) {
      const product = products.find((p) => p._id === id);
      currentEditId = id;

      document.getElementById("edit-name").value = product.name;
      document.getElementById("edit-image").value = product.image;
      document.getElementById("edit-desc").value = product.description;
      document.getElementById("edit-price").value = product.price;

      document.getElementById("edit-modal").classList.add("show");
    }

    async function saveEdit() {
      const data = {
        name: document.getElementById("edit-name").value,
        image: document.getElementById("edit-image").value,
        description: document.getElementById("edit-desc").value,
        price: parseFloat(document.getElementById("edit-price").value),
      };

      if (!data.name || !data.image || !data.description || !data.price) {
        alert("Please fill in all fields!");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/products/${currentEditId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        
        if (!res.ok) {
          throw new Error(`HTTP error! status: ${res.status}`);
        }
        
        const updated = await res.json();
        
        products = products.map((p) =>
          p._id === currentEditId ? updated : p
        );
        
        renderProducts();
        document.getElementById("edit-modal").classList.remove("show");
        alert("Product updated successfully!");
      } catch (err) {
        console.error("Error updating product:", err);
        
        products = products.map((p) =>
          p._id === currentEditId ? { ...p, ...data } : p
        );
        renderProducts();
        document.getElementById("edit-modal").classList.remove("show");
        alert("Product updated locally (server connection issue)");
      }
    }

    function deleteProduct(id) {
      const product = products.find((p) => p._id === id);
      products = products.filter((p) => p._id !== id);
      deletedProducts.push(product);
      renderProducts();
      renderTrash();
    }

    function renderTrash() {
      const trashItems = document.getElementById("trash-items");
      trashItems.innerHTML = "";

      if (deletedProducts.length === 0) {
        trashItems.innerHTML = '<p style="color:#999;">No deleted products</p>';
        return;
      }

      deletedProducts.forEach((p) => {
        const div = document.createElement("div");
        div.className = "trash-item";
        div.innerHTML = `
          <strong>${p.name}</strong><br>
          <button class="restore-btn" onclick="restoreProduct('${p._id}')">Restore</button>
          <button class="perm-delete-btn" onclick="permanentlyDelete('${p._id}')">Permanently Delete</button>
        `;
        trashItems.appendChild(div);
      });
    }

    function restoreProduct(id) {
      const product = deletedProducts.find((p) => p._id === id);
      deletedProducts = deletedProducts.filter((p) => p._id !== id);
      products.push(product);
      renderProducts();
      renderTrash();
    }

    async function permanentlyDelete(id) {
      try {
        await fetch(`${API_URL}/products/${id}`, { method: "DELETE" });
        deletedProducts = deletedProducts.filter((p) => p._id !== id);
        renderTrash();
      } catch (err) {
        console.error("Error:", err);
      }
    }

    async function addProduct() {
      const data = {
        name: document.getElementById("add-name").value,
        image: document.getElementById("add-image").value,
        description: document.getElementById("add-desc").value,
        price: parseFloat(document.getElementById("add-price").value),
      };

      try {
        const res = await fetch(`${API_URL}/products`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data),
        });
        const newProduct = await res.json();
        products.push(newProduct);
        renderProducts();
        document.getElementById("add-modal").classList.remove("show");

        document.getElementById("add-name").value = "";
        document.getElementById("add-image").value = "";
        document.getElementById("add-desc").value = "";
        document.getElementById("add-price").value = "";
      } catch (err) {
        console.error("Error:", err);
      }
    }

    // ==================== CHECKOUT WITH ADDRESS CHECK ====================
    async function checkout() {
      if (cart.length === 0) {
        alert("Your cart is empty!");
        return;
      }

      console.log("üõí Starting checkout...");
      console.log("üì¶ Current userAddress:", userAddress);

      // If address exists in memory, proceed
      if (userAddress && userAddress.completeName) {
        console.log("‚úÖ Using existing address from memory");
        proceedToReceipt();
        return;
      }

      // Try to load from server
      try {
        console.log("üîç Checking server for saved address...");
        const res = await fetch(`${API_URL}/address`);
        if (res.ok) {
          const data = await res.json();
          console.log("üì¶ Server response:", data);
          
          if (data.success && data.addresses && data.addresses.length > 0) {
            userAddress = data.addresses[0];
            localStorage.setItem("userAddress", JSON.stringify(userAddress));
            console.log("‚úÖ Address found on server, proceeding to receipt");
            proceedToReceipt();
            return;
          }
        }
      } catch (err) {
        console.error("‚ùå Error checking for address:", err);
      }

      // No address found - show modal
      console.log("‚ÑπÔ∏è No address found, showing modal");
      document.getElementById("address-modal").classList.add("show");
    }

    function proceedToReceipt() {
      const orderNumber = 'ORD-' + Math.random().toString(36).substr(2, 9).toUpperCase();
      const orderData = {
        orderNumber: orderNumber,
        items: cart,
        total: cart.reduce((sum, item) => sum + (item.price * item.qty), 0),
        address: userAddress,
        date: new Date().toLocaleString()
      };
      sessionStorage.setItem('lastOrder', JSON.stringify(orderData));
      
      cart = [];
      updateCart();
      document.getElementById("cart-sidebar").classList.remove("open");
      
      console.log("‚úÖ Proceeding to receipt page");
      window.location.href = "receipt.html";
    }

    async function saveAddress() {
      const addressData = {
        completeName: document.getElementById("addr-name").value,
        street: document.getElementById("addr-street").value,
        city: document.getElementById("addr-city").value,
        province: document.getElementById("addr-province").value,
        zipCode: document.getElementById("addr-zip").value,
        country: document.getElementById("addr-country").value,
        phoneNumber: document.getElementById("addr-phone").value,
        email: document.getElementById("addr-email").value,
      };

      if (!addressData.completeName || !addressData.street || !addressData.city || 
          !addressData.province || !addressData.zipCode || !addressData.country || 
          !addressData.phoneNumber || !addressData.email) {
        alert("Please fill in all address fields!");
        return;
      }

      try {
        const res = await fetch(`${API_URL}/address`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(addressData),
        });
        const savedAddress = await res.json();
        userAddress = savedAddress.address || addressData;
        
        localStorage.setItem("userAddress", JSON.stringify(userAddress));
        console.log("‚úÖ Address saved successfully");

        document.getElementById("address-modal").classList.remove("show");
        proceedToReceipt();
      } catch (err) {
        console.error("Error saving address:", err);
        userAddress = addressData;
        localStorage.setItem("userAddress", JSON.stringify(addressData));
        
        document.getElementById("address-modal").classList.remove("show");
        proceedToReceipt();
      }
    }

    function openDetailsModal(id) {
      const product = products.find((p) => p._id === id);
      if (!product) return;

      document.getElementById("details-name").textContent = product.name;
      document.getElementById("details-desc").textContent = product.description;

      const addCartBtn = document.getElementById("details-add-cart-btn");
      addCartBtn.onclick = () => {
        addToCart(product._id);
        closeDetailsModal();
      };

      document.getElementById("details-modal").classList.add("show");
    }

    function closeDetailsModal() {
      document.getElementById("details-modal").classList.remove("show");
    }

    document.getElementById("details-close-btn").onclick = closeDetailsModal;

    function logout() {
      if (confirm("Are you sure you want to logout?")) {
        cart = [];
        userAddress = null;
        updateCart();
        
        localStorage.removeItem("user");
        localStorage.removeItem("admin");
        localStorage.removeItem("userAddress");
        
        window.location.href = "login.html";
      }
    }

    document.getElementById("profile-btn").onclick = () => {
      window.location.href = "profile.html";
    };

    document.getElementById("addresses-btn").onclick = () => {
      window.location.href = "address.html";
    };

    document.getElementById("cart-btn").onclick = () => {
      document.getElementById("cart-sidebar").classList.add("open");
    };

    document.getElementById("close-cart-btn").onclick = () => {
      document.getElementById("cart-sidebar").classList.remove("open");
    };

    document.getElementById("trash-btn").onclick = () => {
      if (isAdmin) {
        document.getElementById("trash-sidebar").classList.add("open");
      }
    };

    document.getElementById("close-trash-btn").onclick = () => {
      document.getElementById("trash-sidebar").classList.remove("open");
    };

    document.getElementById("add-btn").onclick = () => {
      if (isAdmin) {
        document.getElementById("add-modal").classList.add("show");
      }
    };

    document.getElementById("checkout-btn").onclick = checkout;

    document.getElementById("save-edit-btn").onclick = saveEdit;
    document.getElementById("cancel-edit-btn").onclick = () => {
      document.getElementById("edit-modal").classList.remove("show");
    };

    document.getElementById("save-add-btn").onclick = addProduct;
    document.getElementById("cancel-add-btn").onclick = () => {
      document.getElementById("add-modal").classList.remove("show");
    };

    document.getElementById("save-addr-btn").onclick = saveAddress;
    document.getElementById("cancel-addr-btn").onclick = () => {
      document.getElementById("address-modal").classList.remove("show");
    };

    document.getElementById("logout-btn").onclick = logout;

    document.getElementById("edit-modal").addEventListener("click", (e) => {
      if (e.target.id === "edit-modal") {
        document.getElementById("edit-modal").classList.remove("show");
      }
    });

    document.getElementById("add-modal").addEventListener("click", (e) => {
      if (e.target.id === "add-modal") {
        document.getElementById("add-modal").classList.remove("show");
      }
    });

    document.getElementById("address-modal").addEventListener("click", (e) => {
      if (e.target.id === "address-modal") {
        document.getElementById("address-modal").classList.remove("show");
      }
    });

    document.getElementById("details-modal").addEventListener("click", (e) => {
      if (e.target.id === "details-modal") {
        document.getElementById("details-modal").classList.remove("show");
      }
    });

    // ==================== FILE UPLOAD FUNCTIONALITY ====================
    document.getElementById("upload-add-btn").addEventListener("click", () => {
      document.getElementById("add-image-file").click();
    });

    document.getElementById("add-image-file").addEventListener("change", (e) => {
      handleFileUpload(e, "add-image");
    });

    document.getElementById("upload-edit-btn").addEventListener("click", () => {
      document.getElementById("edit-image-file").click();
    });

    document.getElementById("edit-image-file").addEventListener("change", (e) => {
      handleFileUpload(e, "edit-image");
    });

    function handleFileUpload(event, targetInputId) {
      const file = event.target.files[0];
      
      if (!file) {
        alert("‚ùå No file selected");
        return;
      }

      if (!file.type.startsWith("image/")) {
        alert("‚ùå Please select an image file!");
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        alert("‚ùå File size must be less than 5MB!");
        return;
      }

      const reader = new FileReader();
      reader.onload = (e) => {
        const base64String = e.target.result;
        document.getElementById(targetInputId).value = base64String;
        
        const button = event.target.previousElementSibling;
        const originalText = button.textContent;
        button.textContent = "‚úÖ Image Uploaded!";
        setTimeout(() => {
          button.textContent = originalText;
        }, 2000);
      };
      
      reader.onerror = () => {
        alert("‚ùå Error reading file");
      };

      reader.readAsDataURL(file);
    }

    // ==================== INITIALIZE ====================
    fetchProducts();
    updateCart();
    renderTrash();

    // üöÄ Load address on page load for users (not admins)
    if (!isAdmin) {
      loadUserAddress();
    }
  </script>
</body>
</html>